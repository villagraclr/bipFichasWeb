@using SistemasBIPS.Models
@model ProgramasViewModels
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@{
    ViewBag.Title = "Ministerio de Desarrollo Social y Familia - Gobierno de Chile";
}
@section styles {
    @Styles.Render("~/Content/Fonts_min")
    @Styles.Render("~/Content/DataTable")
    @Styles.Render("~/Content/HomeFormularios")
}
<div id="page-wrapper">
    <div class="row">
        <ol class="breadcrumb breadcrumbBIPS">            
            <li class="active"><i class="fa fa-users fa-fw"></i> Mis Formularios</li>
        </ol>
    </div>
    <div class="row">
        <!--Filtros-->
        <div class="col-lg-12 anti-padding-RL">            
            <div class="panel panel-info paneles-info">
                <div class="panel-heading paneles-heading">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" href="#acordfiltros">Filtros</a> <span class="caret"></span>
                    </h4>
                </div>
                <div class="panel-collapse collapse" id="acordfiltros">
                    <div class="panel-body paneles-body paneles-font">
                        <ul class="nav nav-tabs">
                            <li class="active"><a href="#fAnos" data-toggle="tab">Años</a></li>
                            <li><a href="#fMinisServ" data-toggle="tab">Ministerios y Servicios</a></li>
                            <li><a href="#fTodosProg" data-toggle="tab">Formularios</a></li>
                        </ul>
                        <div class="tab-content">
                            <!--Filtros años-->                            
                            <div class="tab-pane fade active in" id="fAnos">
                                <div class="panel-body paneles-body">
                                    <div class="col-xs-6 col-md-4 padding-left-filtros">
                                        <ul class="list-group margen-lista">
                                            <li class="list-group-item padding-filtros">
                                                <div class="checkbox margen-checkbox">
                                                    <label><input type="checkbox" name="anosFiltro" value="0" id="todosAnosFiltro" />Todos</label>
                                                </div>
                                            </li>
                                            @{ int anoInicial = 0; }
                                            @foreach (var ano in Model.listaAnos)
                                            {
                                                <li class="list-group-item padding-filtros">
                                                    <div class="checkbox margen-checkbox">
                                                        <label><input type="checkbox" value="@ano" name="anosFiltro" class="anosFiltro" @(ano > anoInicial ? "checked" : string.Empty) />@ano</label>
                                                    </div>
                                                </li>
                                                anoInicial = ano;
                                            }
                                        </ul>
                                    </div>                                    
                                </div>
                            </div>
                            <!--Filtros ministerios/servicios-->
                            <div class="tab-pane fade" id="fMinisServ">
                                <div class="panel-body paneles-body">
                                    <div class="panel-group margen-lista">
                                        @{int i = 0; }
                                        @for (int x = 0; x < 2; x++)
                                        {
                                            <div class="col-xs-6 padding-left-filtros">
                                                @if (Model.listaMinServ.Count > 0)
                                                {
                                                    if (x == 0)
                                                    {
                                                        <div class="panel panel-default">
                                                            <div class="panel-heading paneles-heading-2">
                                                                <h4 class="panel-title paneles-title">
                                                                    <div class="checkbox margen-checkbox">
                                                                        <label><input type="checkbox" name="m0" class="serviciosFiltro" value="0" id="todosMinisterios" />Todos</label>
                                                                    </div>                                                                    
                                                                </h4>
                                                            </div>
                                                        </div>
                                                    }
                                                    int y = x == 0 ? 0 : (Model.listaMinServ.Count / 2);
                                                    foreach (var m in Model.listaMinServ.Skip(y))
                                                    {
                                                        i++;
                                                        <div class="panel panel-default">
                                                            <div class="panel-heading paneles-heading-2">
                                                                <h4 class="panel-title paneles-title">
                                                                    <input type="checkbox" value="@m.Ministerios.IdParametro" id="m@(i)" class="ministeriosFiltro" />
                                                                    <a data-toggle="collapse" data-parent="#panelMinisteriosServicios" href="#filtroMinisterio@(i)">@m.Ministerios.Descripcion</a>
                                                                </h4>
                                                            </div>
                                                            <div id="filtroMinisterio@(i)" class="panel-collapse collapse">
                                                                <ul class="list-group">
                                                                    @if (m.Servicios.Count > 0)
                                                                    {
                                                                        foreach (var s in m.Servicios)
                                                                        {
                                                                            <li class="list-group-item padding-filtros-2">
                                                                                <div class="checkbox margen-checkbox">
                                                                                    <label><input type="checkbox" value="@s.IdParametro" name="s@(i)" class="serviciosFiltro" />@s.Descripcion</label>
                                                                                </div>
                                                                            </li>
                                                                        }
                                                                    }
                                                                </ul>
                                                            </div>
                                                        </div>
                                                        if (i == (Model.listaMinServ.Count / 2)){ break; }
                                                    }
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                            <!--Filtros todos los formularios-->
                            <div class="tab-pane fade" id="fTodosProg">
                                <div class="panel-body paneles-body">
                                    <div class="col-xs-6 col-md-4 padding-left-filtros">
                                        <ul class="list-group margen-lista">
                                            <li class="list-group-item padding-filtros">
                                                <div class="checkbox margen-checkbox">
                                                    <label><input type="checkbox" id="todosFormularios" name="formularios" value="0" />Todos</label>
                                                </div>
                                            </li>
                                            <li class="list-group-item padding-filtros">
                                                <div class="checkbox margen-checkbox">
                                                    <label><input type="checkbox" name="formularios" class="formularios" value="1" checked />Mis formularios</label>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>                    
                </div>
            </div>
        </div>
        <!--Tabla Formularios-->
        <div class="col-lg-12" style="padding-left:0px;padding-right:0px">
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-hover" cellspacing="0" id="tblProgramas">
                    <thead>
                        <tr>
                            <th>ID</th>                            
                            <th>Año</th>
                            <th>Ministerio</th>
                            <th>Servicio</th>
                            <th>Tipo</th>
                            <th>Nombre</th>
                            <th>Etapa</th>
                            <th>Ficha</th>
                            <th>Liberar</th>                        
                        </tr>
                    </thead> 
                    <tbody></tbody>                   
                </table>
            </div>
        </div>
    </div>    
</div>
<!--Modal mensajes-->
<div id="modalMensajesFormularios" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Información</h4>
            </div>
            <div class="modal-body" id="txtMensajesFormulario"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Aceptar</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->
@section scripts {
    @Scripts.Render("~/bundles/DataTable")
    <script src="~/Scripts/jquery.signalR-2.4.2.min.js"></script>
    <script src="~/signalr/hubs"></script>
    <script type="text/javascript">
        var ROOT = "@Url.Content("~/")";
        window.MyApp  = {};
        MyApp.rootPath = '@Url.Content("~")';
        var permisoLibera = "@Model.permisoLibera";
        var arrayFT = [];
        @if (Model.listaFormulariosTomados.Count > 0){
            //int acceso = 0;
            foreach (var item in Model.listaFormulariosTomados){
                <text>arrayFT.push(@item.IdFormulario);</text>
            }
        }
        var tiposProgramas = [];
        @if (Model.listaTiposProgramas.Count > 0){
            foreach(var tipo in Model.listaTiposProgramas)
            {
                <text>
                var m = {};
                m.Id = @(Model.listaRutasFichas.Count > 0 ? (Model.listaRutasFichas.Count(p=>p.Valor == tipo.Valor) > 0 ? tipo.IdParametro : 0) : 0);
                m.IdPadre = @tipo.Valor;
                m.rutaSeguimiento = "@(Model.listaRutasFichas.Count > 0 ? (Model.listaRutasFichas.Count(p=>p.Valor == tipo.Valor && p.Valor2==1) > 0 ? Model.listaRutasFichas.FirstOrDefault(p => p.Valor == tipo.Valor && p.Valor2 == 1).Descripcion : string.Empty) : string.Empty)";
                m.rutaDetalle = "@(Model.listaRutasFichas.Count > 0 ? (Model.listaRutasFichas.Count(p => p.Valor == tipo.Valor && p.Valor2 == 2) > 0 ? Model.listaRutasFichas.FirstOrDefault(p => p.Valor == tipo.Valor && p.Valor2 == 2).Descripcion : string.Empty) : string.Empty)";
                tiposProgramas.push(m);
                </text>
            }
        }
        var anosFichas = [];
        @if (Model.listaAnosFichas.Count > 0){
            //int acceso = 0;
            foreach (var item in Model.listaAnosFichas)
            {
                <text>anosFichas.push(@item.Valor);</text>
            }
        }
        var permisoInfoEval = "@Model.permisoInfoEval";
    </script>
    @Scripts.Render("~/bundles/HomeFormularios")
}